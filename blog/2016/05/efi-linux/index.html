<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <meta name="description" content="A personal website with thoughts on open-source, software development, education and technology." />
        <meta name="author" content="Julie Pichon" />
        <title>EFI, Linux and other boot-loading fun | a.k.a. where's my Grub gone</title>
        <link rel="stylesheet" href="https://www.jpichon.net/theme/css/main.css" />
        <link href="https://www.jpichon.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="jpichon.net Atom Feed" />
        <link href="https://www.jpichon.net/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="jpichon.net RSS Feed" />
        <meta name="description" content="I've been gaming more recently, on hardware that is decent-in-some-contexts-but-definitely-not-in-this-one which has meant pathetic frame rates as..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://www.jpichon.net/">jpichon.net</a></h1>
                <nav><ul>
                    <li><a href="https://www.jpichon.net/blog">Blog</a></li>
                    <li><a href="https://www.jpichon.net/about/">About</a></li>
                    <li><a href="https://www.jpichon.net/feeds/">Feeds</a></li>
                    <li><a href="https://www.jpichon.net/speaking/">Speaking</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://www.jpichon.net/blog/2016/05/efi-linux/" rel="bookmark"
           title="Permalink to EFI, Linux and other boot-loading fun | a.k.a. where's my Grub gone">EFI, Linux and other boot-loading fun  | a.k.a. where's my Grub gone</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-05-30T21:42:00+01:00">
                Published: Mon 30 May 2016
        </abbr>

<!--                <address class="vcard author">
                By                         <a class="url fn" href="https://www.jpichon.net/author/jpichon.html">jpichon</a>
        </address>
 -->
<p>In <a href="https://www.jpichon.net/category/tech.html">Tech</a>.</p>
<p>tags: <a href="https://www.jpichon.net/tag/linux/">linux</a> <a href="https://www.jpichon.net/tag/open-source/">open-source</a> </p>
</footer><!-- /.post-info -->      <p>I've been gaming more recently, on hardware that is
decent-in-some-contexts-but-definitely-not-in-this-one which has meant
pathetic frame rates as low as 7~12FPS as my save files grew bigger. A
kind soul took pity on me and installed a better graphics card in my
machine while I wasn't looking - which of course is when everything
started going wrong.</p>
<p>I'll gloss over the &quot;Not turning on&quot; part because that was due to
mislabelled wires - the real problem began when Windows for some reason
picked up that something had changed at boot time, and promptly
overwrote the boot loader.</p>
<div class="section" id="cannot-boot-from-usb-keys">
<h2>Cannot boot from USB keys</h2>
<p>None of my LiveUSB sticks would boot.</p>
<p>This turned out to be due to the device (or the system on it?) not being
compatible with EFI. I'm not sure how to make a EFI-compatible Live USB
system and didn't need to in the end - if you absolutely need to,
enabling CSM mode in the BIOS (&quot;Compatibility Support Module&quot;) was
useful there, but likely wouldn't have helped with fixing my
boot-loader. EFI and Legacy OS shouldn't be dual-booted in parallel -
you can read more about this at the beginning of that <a class="reference external" href="http://www.rodsbooks.com/linux-uefi/">excellent
page</a>.</p>
</div>
<div class="section" id="side-note-chroot-cannot-execute-bin-sh">
<h2>Side-note: &quot;chroot: cannot execute /bin/sh&quot;</h2>
<p>That was because the Live USB stick turned out to be a 32 bit system,
while my desktop OS is 64 bits.</p>
</div>
<div class="section" id="where-s-my-efi-partition-anyway">
<h2>Where's my EFI partition anyway</h2>
<p>I found an old install CD for Debian testing 7.10 (64 bits) lying around
that turned out to have a Rescue mode option.</p>
<p>To prepare the system for the chroot that would fix All My Problems,
first I had to figure out what was on which partition. The rescue mode
let me mount them one by one and take a peek, though using <em>parted</em>
would have been much faster.</p>
<pre class="literal-block">
# parted /dev/sda print
Model: Blah
Disk /dev/sda: 1000GB
Sector size (logical/physical): 512B/4096B
Partition Table: gpt
Disk Flags:

Number&nbsp; Start&nbsp;&nbsp; End&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp;&nbsp;&nbsp; File system&nbsp;&nbsp;&nbsp;&nbsp; Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Flags
&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1049kB&nbsp; 420MB&nbsp;&nbsp; 419MB&nbsp;&nbsp; ntfs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Basic data partition&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hidden, diag
&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 420MB&nbsp;&nbsp; 735MB&nbsp;&nbsp; 315MB&nbsp;&nbsp; fat32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EFI system partition&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; boot, esp
&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 735MB&nbsp;&nbsp; 869MB&nbsp;&nbsp; 134MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Microsoft reserved partition&nbsp; msftres
&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 869MB&nbsp;&nbsp; 247GB&nbsp;&nbsp; 247GB&nbsp;&nbsp; ntfs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Basic data partition&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msftdata
&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 247GB&nbsp;&nbsp; 347GB&nbsp;&nbsp; 100GB&nbsp;&nbsp; ext4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; debian-root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msftdata
etc etc etc
</pre>
<p>So my Debian partition is on /dev/sda6, the EFI stuff is on /dev/sda2. I
need to make a Debian chroot and reinstall Grub from there - that's the
kind of stuff I learnt <a class="reference external" href="https://www.jpichon.net/blog/2010/10/recovering-a-lost-partition-table/">last time I broke a lot of
things</a>.</p>
</div>
<div class="section" id="let-s-chroot-and-grub">
<h2>Let's chroot and grub!</h2>
<p>After selecting the &quot;Execute a shell in Installer environment&quot; option:</p>
<pre class="literal-block">
# mount /dev/sda6 /mnt
# mount -o bind /dev /mnt/dev
# chroot /mnt
</pre>
</div>
<div class="section" id="error-update-grub-device-node-not-found">
<h2>Error: update-grub: device node not found</h2>
<p>This one I think happened because I only bind mounted /dev, when you
also need things like /dev/pts, /sys, /proc.</p>
<pre class="literal-block">
# for i in /dev /dev/pts /proc /sys ; do mount -o bind $i /mnt$i ; done
</pre>
</div>
<div class="section" id="error-grub-install-dev-sda-cannot-find-efi-directory">
<h2>Error: grub-install /dev/sda: cannot find EFI directory</h2>
<p>That one was before I figured out I also needed to mount the EFI special
boot partition - sda2 as shown in the printed output.</p>
<pre class="literal-block">
# mount /dev/sda2 /mnt/boot/efi
</pre>
<p>From then on I read about the <em>efibootmgr</em> tool and decided to try and
use that instead.</p>
</div>
<div class="section" id="error-efibootmgr-efi-variables-are-not-supported-on-this-system">
<h2>Error: efibootmgr: EFI variables are not supported on this system</h2>
<p>Outside the chroot, you need to <a class="reference external" href="https://unix.stackexchange.com/questions/91620/arch-linux-grub-install-efi-variables-are-not-supported-on-this-system#91623">load the efivars
module</a>:</p>
<pre class="literal-block">
# modprobe efivars
</pre>
</div>
<div class="section" id="how-are-things-looking-by-now">
<h2>How are things looking by now</h2>
<pre class="literal-block">
# modprobe efivars
# mount /dev/sda6 /mnt
# mount /dev/sda2 /mnt/boot/efi
# for i in /dev /dev/pts /proc /sys ; do mount -o bind $i /mnt$i ; done
# chroot /mnt
</pre>
<p>Usually I can never remember the <em>mount</em> syntax (does the mount point
come first or second?!) but I typed these commands so many times today,
I bet I'll remember the syntax for <em>at least</em> a week.</p>
</div>
<div class="section" id="playing-with-efibootmgr">
<h2>Playing with efibootmgr</h2>
<p>I tried to use the following command from the &quot;<a class="reference external" href="http://www.rodsbooks.com/efi-bootloaders/installation.html">Managing EFI Boot
Loaders for
Linux</a>&quot;
page but it didn't quite work for me.</p>
<pre class="literal-block">
# efibootmgr -c -d /dev/sda -p 2 -l \\EFI\\debian\\grubx64.efi -L Linux
</pre>
<p>While this did add a Linux entry to my F12 BIOS boot menu (yay!), that
booted straight into a black screen (&quot;Reboot and Select proper Boot
Device or Insert Boot Media&quot; etc etc). Later on I learnt about the
<em>efibootmgr --verbose</em> command which shows the difference between the
working entry and the non-working one:</p>
<pre class="literal-block">
# efibootmgr --verbose
Boot0000* debian&nbsp;&nbsp;&nbsp; HD(2,c8800,96000,0123456789-abcd-1234)File(\EFI\debian\grubx64.efi)
Boot0005&nbsp; Linux&nbsp;&nbsp;&nbsp; HD(2,c8800,96000,0123456789-abcd-1234)File(\EFI\redhat\grub.efi)\EFI\debian\grubx64.efi
</pre>
<p>I'm not quite sure how the path ended up looking like that. It could be
a default somewhere, or I'm quite willing to believe I did something
wrong - I also made a mistake on the partition number when I first ran
the command.</p>
</div>
<div class="section" id="but-how-did-you-fix-it">
<h2>But how did you fix it?!</h2>
<p>Despite showing all the options I wanted in the <em>efibootmgr</em> output
within the chroot, running <em>grub-install</em> and <em>update-grub</em> multiple
times did nothing: I'd still boot straight into Windows or straight into
a black screen. The strange thing is that even though only &quot;Windows Boot
Manager&quot; and my new &quot;Linux&quot; entry were in the F12 boot menu, the BIOS
setup did offer a 'debian' entry (created automatically at install time
a long time ago) was in the boot ordering options. Moving it around
didn't change a thing though.</p>
<p>The <em>efibootmgr</em> man page talks of a &quot;BootNext&quot; option. With the
'debian' entry right in front of me, why not try it? It's entry Boot0000
on my list, therefore:</p>
<pre class="literal-block">
# efibootmgr -n 0
</pre>
<p>Ta-dah! I rebooted straight into Grub then Debian. From there,
<em>grub-install /dev/sda</em> and <em>update-grub</em> worked just fine.</p>
</div>
<div class="section" id="things-i-still-don-t-know">
<h2>Things I still don't know</h2>
<ul class="simple">
<li>Why did this happen in the first place? Can I prevent it from
happening again?</li>
<li>I'm not sure why the grub install properly worked that last time. Did
I miss something when working from the chroot?</li>
<li>Where does the &quot;redhat\grub.efi&quot; line come from, and can I amend
that?</li>
<li>Why does Windows take so long to restart each time, when I don't even
log in?</li>
</ul>
</div>
<div class="section" id="references">
<h2>References</h2>
<ul class="simple">
<li><a class="reference external" href="http://www.rodsbooks.com/linux-uefi/">Linux on UEFI: A quick installation
guide</a> - I found this site
incredibly informational.</li>
<li>The <a class="reference external" href="http://linux.die.net/man/8/efibootmgr">efibootmgr man page</a>
is very nice and contains useful examples.</li>
<li><a class="reference external" href="https://wiki.debian.org/GrubEFIReinstall">GrubEFIReinstall</a> - I
probably would have tried that tool at some point. I postponed
because I didn't have an easy way to burn a CD and wasn't sure about
how to boot from USB without enabling CSM.</li>
<li><a class="reference external" href="http://mjg59.livejournal.com/138188.html">Booting with EFI</a>, a
blog entry about fallback boot loaders. While this didn't help in my
case, I found the article very clear and enjoyed getting an
explanation of the context around the problem in addition to the
solution.</li>
</ul>
<p>Punch line: the graphics card wasn't the bottle neck and my frame rate
still hovers around 9FPS.</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://www.jpichon.net/archives.html">Archives</a></li>
                            <li><a href="https://www.jpichon.net/about">About</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <!--                             <li><a href="https://www.jpichon.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
 -->
                            <li><a href="https://www.jpichon.net/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">rss feed</a></li>

                            <li><a href="https://github.com/jpichon">jpichon</a></li>
                            <li><a rel="me" href="https://mastodon.ie/@jpichon">@jpichon@mastodon.ie</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
          <address id="about" class="vcard body">
            Powered by <a href="http://getpelican.com/">Pelican</a>.
            Theme based on the one made by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a
          </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

</body>
</html>